<button style="margin:auto;display:inline;border:solid 1px" onclick="addTitle()">Add Section Label</button> 
<button style="margin:auto;display:inline;border:solid 1px" onclick="addSelectionQuestion()">Add Selection Question</button> 
<button style="margin:auto;display:inline;border:solid 1px" onclick="addTypingQuestion()">Add Typing Question</button> 
<button style="margin:auto;display:inline;border:solid 1px" onclick="addArrangingQuestion()">Add Arranging Question</button> 
<button style="margin:auto;display:inline;border:solid 1px" onclick="addAudioQuestion()">Add Audio question</button> 
<button style="margin:auto;display:inline;border:solid 1px" onclick="finish()">Finish</button> 
<button style="margin:auto;display:inline;border:solid 1px" onclick="clearField()">Clear</button> 
<br><br>
<div name="visualbox"></div>
<br><br>
<textarea name="codebox" style="width:90%;padding:1em;border:1px solid" rows=25><br>
<div name="pointsbox" style="font-size:25px;display:none;color:green"></div><br>

<button style="margin:auto;display:block;border: solid 2px" onclick="showAnswer()">チェックする</button>
<script>
function showAnswer() {
  var points = 0;
  //multiplechoice
  multiplechoice.forEach(function(question) {
    var selected = document.querySelector('input[name=' + question + ']:checked');
    if (selected !== null) {
      var element = document.getElementsByName(question + selected.value + "check")[0];
      element.style.display = "inline";
      if (element.textContent == "O") {
        points = points + 1;
      }
      var note = document.getElementsByName(question + "note");
      if (note.length > 0) {
        note[0].style.display = "inline";
      }
    }
  })
  //textbasedquestion
  textbasedquestion.forEach(function(question) {
    var input = document.getElementsByName(question + "a1")[0].value;
    if (input.length > 0) {
      var answerElement = document.getElementsByName(question + "a1check")[0];
      if (mapString(input).trim().toUpperCase() == answerElement.textContent) {
        answerElement.style.color = "green";
        points = points + 1;
      }
      answerElement.style.display = "inline";
      var note = document.getElementsByName(question + "note");
      if (note.length > 0) {
        note[0].style.display = "inline";
      }
    }
  })
  var totalpoints = multiplechoice.length + textbasedquestion.length;
  var pointsbox = document.getElementsByName("pointsbox")[0];
  pointsbox.style.display = "block";
  pointsbox.textContent = "結果： " + points + "/" + totalpoints;
}

function mapString(input) {
  return tr(input, "ＡａＢｂＣｃＤｄＥｅＦｆＧｇＨｈＩｉＪｊＫｋＬｌＭｍＮｎＯｏＰｐＱｑＲｒＳｓＴｔＵｕＶｖＷｗＸｘＹｙＺｚ　", "AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz ");
}

function tr( text, search, replace ) {
  // Make the search string a regex.
  var regex = RegExp( '[' + search + ']', 'g' );
  var t = text.replace( regex, 
          function( chr ) {
              // Get the position of the found character in the search string.
              var ind = search.indexOf( chr );
              // Get the corresponding character from the replace string.
              var r = replace.charAt( ind );
              return r;
          } );
  return t;
}

</script></textarea>

<script>
var currentQuestion = 0;
var selectionQuestion = [];
var textbaseQuestion = [];
var codeboxElement = document.getElementsByName("codebox")[0];
var visualElement= document.getElementsByName("visualbox")[0];
var script = codeboxElement.value;
codeboxElement.value = '';

function clearField() {
  currentQuestion = 0;
  codeboxElement.value = '';
  visualElement.innerHTML = '';
}

function finish() {
  codeboxElement.value += script.replace("//multiplechoice", "var multiplechoice = ['" + selectionQuestion.join("','") + "'];").replace("//textbasedquestion", "var textbasedquestion = ['" + textbaseQuestion.join("','") + "'];");
}

function addSelectionQuestion() {
  var question = prompt("Question text");
  if ((question != null) && (question.length > 0)) {
  　currentQuestion += 1;
    addQuestionText(question);
    addMultipleChoice();
    addNote(prompt("Any note?"));
    selectionQuestion.push("q" + currentQuestion);
  }
}

function addAudioQuestion() {
  var url = prompt("Audio URL");
  if ((url != null) && (url.length > 0)) {
  　currentQuestion += 1;
    var audio = document.createElement("audio");
    audio.controls = true;
    var source = document.createElement("source");
    source.setAttribute('src', url);
    audio.appendChild(source);
    audio.appendChild(document.createTextNode("Your browser does not support the audio element."));
    visualElement.appendChild(audio);
    addBr();
    addBr();
    codeboxElement.value += audio.outerHTML + "<br><br>" + '\r\n';
    addMultipleChoice();
    addNote(prompt("Any note?"));
    selectionQuestion.push("q" + currentQuestion);
  }
}

function addArrangingQuestion() {
  var input = prompt("How many parts (maximum 8)?");
  if ((input != null) && (input.length > 0)) {
  　currentQuestion += 1;
    var num = mapNumber(input);
    var parts = [];
    for (let i=1; i<=num; i++) {
      parts.push(prompt("Part " + i + "/" + num));
    }
    var tableElement = document.createElement("table");
    var tr1Element = document.createElement("tr");
    var tr2Element = document.createElement("tr");
    var cutoff = 3;
    if (num > 6) {
      cutoff = 4;
    }
    for (let i=0; i<cutoff; i++) {
      var tdElement = document.createElement("td");
      tdElement.style = "border: 1px solid;width: 25%;";
      tdElement.appendChild(document.createTextNode(parts[i]));
      tr1Element.appendChild(tdElement);
    }
    for (let i=cutoff; i<num; i++) {
      var tdElement = document.createElement("td");
      tdElement.style = "border: 1px solid;width: 25%;";
      tdElement.appendChild(document.createTextNode(parts[i]));
      tr2Element.appendChild(tdElement);
    }
    tableElement.appendChild(tr1Element);
    tableElement.appendChild(tr2Element);
    visualElement.appendChild(tableElement);
    addBr();
    codeboxElement.value += tableElement.outerHTML + "<br>" + '\r\n';
    addInputBox();
    addAnswer(prompt("Correct answer"));
    addNote(prompt("Any note?"));
    textbaseQuestion.push("q" + currentQuestion);
  }
}

function addTitle() {
  var title = prompt("Section label");
  if ((title != null) && (title.length > 0)) {
    var titleElement = document.createElement('h3');
    titleElement.innerText = title;
    visualElement.appendChild(titleElement);
    addBr();
    codeboxElement.value += titleElement.outerHTML + "<br>" + '\r\n';
  }
}

function addTypingQuestion() {
  var question = prompt("Question text");
  if ((question != null) && (question.length > 0)) {
  　currentQuestion += 1;
  	addQuestionText(question);
    addBr();
    codeboxElement.value += "<br>" + '\r\n';
  	addInputBox();
  	addAnswer(prompt("Correct answer"));
  	addNote(prompt("Any note?"));
  	textbaseQuestion.push("q" + currentQuestion);
  }
}

function addMultipleChoice() {
  var num = mapNumber(prompt("How many choices?"));
  var answers = [];
  for (let i=1; i<=num; i++) {
    answers.push(prompt("Choice " + i));
  }
  var correct = mapNumber(prompt("Correct choice?"));
  for (let i=1; i<=num; i++) {
    var input = document.createElement("input");
    input.type = "radio";
    input.id = "q" + currentQuestion + "a" + i;
    input.setAttribute('name', "q" + currentQuestion);
    input.setAttribute('value', "a" + i);
    var label = document.createElement("label");
    label.setAttribute('for', input.id);
    label.appendChild(document.createTextNode(answers[i-1]));
    var div = document.createElement("div");
    div.setAttribute('name', "q" + currentQuestion + "a" + i + "check");
    if (i == correct) {
      div.style = "display:none;color:green";
      div.textContent = "O";
    } else {
      div.style = "display:none;color:red";
      div.textContent = "X";
    }
    visualElement.appendChild(input);
    visualElement.appendChild(label);
    visualElement.appendChild(div);
    addBr();
    codeboxElement.value += input.outerHTML + '\r\n';
    codeboxElement.value += label.outerHTML + '\r\n';
    codeboxElement.value += div.outerHTML + "<br>" + '\r\n';
  }
}

function addBr() {
  visualElement.appendChild(document.createElement('br'));
}

function addQuestionText(question) {
  visualElement.innerHTML += question;
  addBr();
  codeboxElement.value += question + "<br>" + '\r\n';
}

function addInputBox() {
  var inputElement = document.createElement('input');
  inputElement.name = "q" + currentQuestion + "a1";
  inputElement.type = 'text';
  inputElement.style = 'text-transform:uppercase;border: 1px solid';
  visualElement.appendChild(inputElement);
  codeboxElement.value += inputElement.outerHTML + '\r\n';
}

function addAnswer(answer) {
  var answerElement = document.createElement('div');
  answerElement.setAttribute('name', "q" + currentQuestion + "a1check");
  answerElement.style = 'display:none;color:red';
  answerElement.textContent = mapString(answer).trim().toUpperCase();
  visualElement.appendChild(answerElement);
  addBr();
  codeboxElement.value += answerElement.outerHTML + "<br>" + '\r\n';
}

function addNote(note) {
  if ((note != null) && (note.length > 0)) {
    var noteElement = document.createElement('div');
    noteElement.setAttribute('name', "q" + currentQuestion + "note");
    noteElement.style = 'display:none;color:blue';
    noteElement.textContent = note;
    visualElement.appendChild(noteElement);
    codeboxElement.value += noteElement.outerHTML;
  }
  addBr();
  codeboxElement.value += "<br>" + '\r\n';
}

function mapNumber(input) {
  return parseInt(tr(input, "０１２３４５６７８９　", "0123456789 "));
}

function mapString(input) {
  return tr(input, "ＡａＢｂＣｃＤｄＥｅＦｆＧｇＨｈＩｉＪｊＫｋＬｌＭｍＮｎＯｏＰｐＱｑＲｒＳｓＴｔＵｕＶｖＷｗＸｘＹｙＺｚ　", "AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz ");
}

function tr( text, search, replace ) {
  // Make the search string a regex.
  var regex = RegExp( '[' + search + ']', 'g' );
  var t = text.replace( regex, 
          function( chr ) {
              // Get the position of the found character in the search string.
              var ind = search.indexOf( chr );
              // Get the corresponding character from the replace string.
              var r = replace.charAt( ind );
              return r;
          } );
  return t;
}

</script>
